import{i as $,c as _,E as F,a as j,e as w,A as N,b as y,s as b,g as U,n as m,d as p,w as L,u as G,j as a,S as E,f as H,h as B,k as R,l as A}from"./index-B0VHPENL.js";import{b as k,d as C,B as h,I as T,e as I,f as K}from"./primereact-PWt0ZiM-.js";import{u as S}from"./redux-vendor-CJ8-OCLT.js";import{a as d}from"./react-vendor-D_ZCUrOg.js";import{P as q,B as W}from"./backgrounds-BoYJZBYz.js";import"./i18n-5_3iJCmZ.js";const J={maxAttempts:3,initialDelay:1e3,maxDelay:1e4,backoffMultiplier:2,retryCondition:$};async function Q(e,t={},n){const i={...J,...t};let o,s=i.initialDelay;for(let r=1;r<=i.maxAttempts;r++)try{return{success:!0,data:await e(),attempts:r}}catch(c){const l=_(c,j.UNKNOWN,F.MEDIUM,{...n,attempt:r});if(o=l,w.logErrorWithRetry(c,{...n,attempt:r},r-1),!(r<i.maxAttempts&&(i.retryCondition?i.retryCondition(l):!0)))break;i.onRetry&&i.onRetry(r,l),r<i.maxAttempts&&(await Y(s),s=Math.min(s*i.backoffMultiplier,i.maxDelay))}return{success:!1,error:o,attempts:i.maxAttempts}}function Y(e){return new Promise(t=>setTimeout(t,e))}const z={useServerInfoLoadingService:()=>{const e=S(n=>n.serverInfoReducer.serverInfo),t=d.useRef(!1);d.useEffect(()=>{e||t.current||v(e,t);const n=setInterval(()=>{t.current||v(e,t)},N.REFRESH_INTERVAL_MS);return()=>{clearInterval(n)}},[e])}},v=async(e,t)=>{var i;t.current=!0;const n=await Q(async()=>{const o=new AbortController,s=setTimeout(()=>o.abort(),N.DEFAULT_TIMEOUT_MS);try{const r=await fetch(p.SERVER_INFO,{signal:o.signal});if(clearTimeout(s),!r.ok)throw new Error(`HTTP error! status: ${r.status}`);const c=await r.json(),l=JSON.stringify(c);if(l.includes("GDError")||l.includes("Couldn't query"))throw new Error("Game server query timeout - backend could not reach game server");return c}catch(r){throw clearTimeout(s),r}},{maxAttempts:3,initialDelay:2e3,retryCondition:o=>{var s;return o.type===j.NETWORK||o.type===j.SERVER&&o.code!==500||((s=o.message)==null?void 0:s.includes("query timeout"))}},{component:"ServerInfoService",action:"fetch_server_info"});try{if(n.success&&n.data){const o=n.data;o.status=Object.keys(o).length>0?"1":"0",y.dispatch(b.setServerInfo(o))}else if(n.error)if(w.logError(n.error,{component:"ServerInfoService",action:"fetch_server_info",attempts:n.attempts},n.error.type,n.error.severity),(i=n.error.message)==null?void 0:i.includes("query timeout")){if(console.warn("Game server query timeout - retaining last known data"),!e){const s={name:"Kether.pl",map:"–",players:"0",maxplayers:"0",bots:0,playerdetails:[],status:"0"};y.dispatch(b.setServerInfo(s))}}else{const s=U(n.error);m.ERROR(s);const r={name:"Kether.pl",map:"–",players:"0",maxplayers:"0",bots:0,playerdetails:[],status:"0"};y.dispatch(b.setServerInfo(r))}}finally{t.current=!1}};function X(){const e=S(s=>s.serverInfoReducer.serverInfo),t=G();z.useServerInfoLoadingService();const n=d.useCallback(s=>{const r=~~(s/3600),c=~~(s%3600/60),l=~~s%60;let u="";return r>0&&(u+=""+r+":"+(c<10?"0":"")),u+=""+c+":"+(l<10?"0":""),u+=""+l,u},[]),i=d.useCallback(s=>a.jsx("span",{children:n(s.duration)}),[n]),o=d.useCallback(()=>{var s;return(s=e==null?void 0:e.playerdetails)!=null&&s.length?a.jsx("div",{className:"player-list-table",children:a.jsxs(k,{value:e.playerdetails,removableSort:!0,sortMode:"multiple",scrollable:!0,emptyMessage:t.noPlayersAvailable,children:[a.jsx(C,{field:"name",header:t.nickname,sortable:!0}),a.jsx(C,{field:"score",header:t.score,sortable:!0}),a.jsx(C,{body:i,header:t.duration})]})}):null},[e,i,t]);return a.jsxs("div",{className:"section future-rot",children:[a.jsxs("span",{children:[t.name,": ",e==null?void 0:e.name]}),a.jsxs("span",{children:["IP: ",E.IP,a.jsx(h,{icon:"pi pi-copy",style:{scale:"0.8",verticalAlign:"unset"},onClick:()=>{navigator.clipboard.writeText(E.IP),m.SUCCESS(H.COPY_SUCCESS)}})]}),a.jsxs("span",{children:[t.players,": ",e==null?void 0:e.players,"/",e==null?void 0:e.maxplayers," (",e==null?void 0:e.bots," ",(e==null?void 0:e.bots)===1?t.bot:t.bots,")"]}),a.jsxs("span",{children:[t.status,": ",(e==null?void 0:e.status)==="1"?t.online:t.offline]}),a.jsxs("span",{children:[t.map,": ",e==null?void 0:e.map]}),a.jsx("span",{children:a.jsx(h,{label:t.joinGame,onClick:()=>{window.location.href=E.STEAM_CONNECT_URL}})}),o()&&a.jsx("span",{children:o()}),a.jsxs("span",{className:"centered-text",children:[t.customMapsText,a.jsx("a",{style:{display:"inline-block",marginLeft:"10px",textDecoration:"none",color:"white",WebkitTextStroke:" 3px red"},href:"https://steamcommunity.com/sharedfiles/filedetails/?id=2542824628",children:t.here})]})]})}const Z=L(X),g={useCommandsLoadingService:()=>{ee()},getCommands:()=>fetch(`${p.COMMANDS}/getCommands`,{method:"get"}).then(e=>{if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return e.json()}).then(e=>{y.dispatch(B.setCommands(e))}).catch(e=>{m.ERROR(`Error while fetching commands: ${e.message}`)}),addNewCommand:e=>fetch(`${p.COMMANDS}/addCommand`,{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify({command:e.command,description:e.description})}).then(t=>{if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);return t.json()}).then(t=>(g.getCommands(),t)).catch(t=>{throw m.ERROR(`Error while adding new command: ${t.message}`),t}),deleteCommand:e=>fetch(`${p.COMMANDS}/deleteCommand`,{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:e.id})}).then(t=>{if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);return t.json()}).then(t=>(g.getCommands(),t.message)).catch(t=>{throw m.ERROR(`Error while deleting command: ${t.message}`),t}),updateCommand:e=>fetch(`${p.COMMANDS}/updateCommand`,{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:e.id,command:e.command,description:e.description})}).then(t=>{if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);return t.json()}).then(t=>(g.getCommands(),t.message)).catch(t=>{throw m.ERROR(`Error while updating command: ${t.message}`),t})},ee=()=>{d.useEffect(()=>{g.getCommands()},[])};function O(e){return a.jsxs(a.Fragment,{children:[a.jsx("h5",{children:"Command"}),a.jsx(T,{value:e.command,onChange:t=>e.setCommand(t.target.value)}),a.jsx("h5",{children:"Description"}),a.jsx(T,{value:e.commandDescription,onChange:t=>e.setCommandDescription(t.target.value)})]})}function te(e){const t=R(),n=A(),i=()=>a.jsxs(a.Fragment,{children:[a.jsx(h,{label:n.cancel,icon:"pi pi-times",className:"p-button-text",onClick:()=>{e.commandEditingIdRef.current=-1,e.setDialogVisibility(!1)}}),a.jsx(h,{label:n.update,icon:"pi pi-check",className:"p-button-text",onClick:()=>{const o={command:e.command,description:e.commandDescription,id:e.commandEditingIdRef.current};g.updateCommand(o).then(()=>{m.SUCCESS("Successfully updated the command"),e.setDialogVisibility(!1),e.commandEditingIdRef.current=-1}).catch(s=>{m.ERROR(`Couldn't update the command: ${s.message}`)})}})]});return a.jsx(I,{visible:e.isDialogVisible,header:t.editCommand,modal:!0,className:"p-fluid",footer:i(),onHide:()=>{e.setDialogVisibility(!1)},children:a.jsx(O,{command:e.command,commandDescription:e.commandDescription,setCommand:e.setCommand,setCommandDescription:e.setCommandDescription})})}function ae(e){const t=R(),n=A(),i=a.jsxs(a.Fragment,{children:[a.jsx(h,{label:n.cancel,icon:"pi pi-times",className:"p-button-text",onClick:()=>e.setDialogVisibility(!1)}),a.jsx(h,{label:n.save,icon:"pi pi-check",className:"p-button-text",onClick:()=>{const o={command:e.command,description:e.commandDescription};g.addNewCommand(o).then(()=>{m.SUCCESS(t.successfullyAdded),e.setDialogVisibility(!1),e.setCommandDescription("")}).catch(s=>{m.ERROR(`${t.couldntAdd}: ${s.message}`)})}})]});return a.jsx(I,{visible:e.isDialogVisible,header:t.addNewCommand,modal:!0,className:"p-fluid",footer:i,onHide:()=>e.setDialogVisibility(!1),children:a.jsx(O,{setCommandDescription:e.setCommandDescription,commandDescription:e.commandDescription,setCommand:e.setCommand,command:e.command})})}function ne(){const e=S(f=>f.userDataReducer.isAdmin),t=S(f=>f.commandsReducer.commands),n=R(),[i,o]=d.useState(""),s=d.useRef(-1),[r,c]=d.useState(""),[l,u]=d.useState(!1),[M,D]=d.useState(!1);g.useCommandsLoadingService();const P=f=>a.jsxs(a.Fragment,{children:[a.jsx(h,{"data-toggle":"tooltip",title:n.editCommandTooltip,icon:"pi pi-pencil",className:"p-button-rounded mr-2",onClick:()=>{s.current=f.id,D(!0),c(f.command),o(f.description)}}),a.jsx(h,{"data-toggle":"tooltip",title:n.deleteCommandTooltip,icon:"pi pi-trash",className:"p-button-rounded p-button-danger",onClick:()=>{g.deleteCommand(f).then(x=>{m.SUCCESS(`${x}`),u(!1),o("")}).catch(x=>{m.ERROR(`${n.couldntDelete}: ${x}`)})}})]}),V=()=>a.jsx(a.Fragment,{children:e&&a.jsx(h,{label:n.newCommand,icon:"pi pi-plus",className:"mr-2","data-toggle":"tooltip",title:n.addNewCommandTooltip,onClick:()=>u(!0)})});return a.jsxs("div",{className:"section",children:[a.jsx(ae,{setCommandDescription:o,commandDescription:i,setCommand:c,command:r,isDialogVisible:l,setDialogVisibility:u}),a.jsx(te,{setCommandDescription:o,commandDescription:i,setCommand:c,command:r,commandEditingIdRef:s,isDialogVisible:M,setDialogVisibility:D}),e&&a.jsx(K,{className:"mb-4",start:V()}),a.jsxs(k,{value:t,responsiveLayout:"scroll",style:{backgroundColor:"transparent",background:"transparent",backdropFilter:"blur(2px)"},emptyMessage:n.noCommandsAvailable,children:[a.jsx(C,{field:"command",header:n.command}),a.jsx(C,{field:"description",header:n.description}),e&&a.jsx(C,{header:n.actions,body:P})]})]})}function le(){return a.jsx(q,{imageUrl:W.BACKGROUND_1,children:a.jsxs("div",{className:"home-page",children:[a.jsx(Z,{}),a.jsx(ne,{})]})})}export{le as default};
