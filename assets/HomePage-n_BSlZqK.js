import{i as e,c as s,E as t,a,e as n,A as o,b as r,s as i,g as c,n as l,d as m,w as d,u as p,j as u,S as h,f,h as g,k as C,l as x,m as j}from"./index-PUGTdxub.js";import{b,d as y,B as v,I as S,e as E,f as N}from"./primereact-C2ngy8op.js";import{u as R}from"./redux-vendor-y6Da-rhS.js";import{a as D}from"./react-vendor-CFOk4vZh.js";import{P as w,B as T}from"./backgrounds-cpbz9wIW.js";import"./i18n-X45JNxKt.js";const k={maxAttempts:3,initialDelay:1e3,maxDelay:1e4,backoffMultiplier:2,retryCondition:e};function A(e){return new Promise(s=>setTimeout(s,e))}const O=e=>({name:e,map:"â€“",players:"0",maxplayers:"0",bots:0,playerdetails:[],status:"0"}),I=e=>async function(e,o={},r){const i={...k,...o};let c,l=i.initialDelay;for(let d=1;d<=i.maxAttempts;d++)try{return{success:!0,data:await e(),attempts:d}}catch(m){const e=s(m,a.UNKNOWN,t.MEDIUM,{...r,attempt:d});if(c=e,n.logErrorWithRetry(m,{...r,attempt:d},d-1),!(d<i.maxAttempts)||i.retryCondition&&!i.retryCondition(e))break;i.onRetry&&i.onRetry(d,e),d<i.maxAttempts&&(await A(l),l=Math.min(l*i.backoffMultiplier,i.maxDelay))}return{success:!1,error:c,attempts:i.maxAttempts}}(async()=>{const s=new AbortController,t=setTimeout(()=>s.abort(),o.DEFAULT_TIMEOUT_MS);try{const a=await fetch(e,{signal:s.signal});if(clearTimeout(t),!a.ok)throw new Error(`HTTP error! status: ${a.status}`);const n=await a.json(),o=JSON.stringify(n);if(o.includes("GDError")||o.includes("Couldn't query"))throw new Error("Game server query timeout - backend could not reach game server");return n}catch(a){throw clearTimeout(t),a}},{maxAttempts:3,initialDelay:2e3,retryCondition:e=>{var s;return e.type===a.NETWORK||e.type===a.SERVER&&500!==e.code||(null==(s=e.message)?void 0:s.includes("query timeout"))}},{component:"ServerInfoService",action:"fetch_server_info"}),$=()=>{const e=R(e=>e.serverInfoReducer.serverInfo),s=D.useRef(!1);D.useEffect(()=>{e||s.current||M(e,s);const t=setInterval(()=>{s.current||M(e,s)},o.REFRESH_INTERVAL_MS);return()=>{clearInterval(t)}},[e])},M=async(e,s)=>{var t;s.current=!0;const a=await I(m.SERVER_INFO);try{if(a.success&&a.data){const e=(o=a.data,{...o,status:Object.keys(o).length>0?"1":"0"});r.dispatch(i.setServerInfo(e))}else if(a.error){n.logError(a.error,{component:"ServerInfoService",action:"fetch_server_info",attempts:a.attempts},a.error.type,a.error.severity);if(null==(t=a.error.message)?void 0:t.includes("query timeout")){if(!e){const e=O("Kether.pl");r.dispatch(i.setServerInfo(e))}}else{const e=c(a.error);l.ERROR(e);const s=O("Kether.pl");r.dispatch(i.setServerInfo(s))}}}finally{s.current=!1}var o};const _=d(function(){const e=R(e=>e.serverInfoReducer.serverInfo),s=p();$();const t=D.useCallback(e=>{const s=~~(e/3600),t=~~(e%3600/60),a=~~e%60;let n="";return s>0&&(n+=s+":"+(t<10?"0":"")),n+=t+":"+(a<10?"0":""),n+=""+a,n},[]),a=D.useCallback(e=>u.jsx("span",{children:t(e.duration)}),[t]),n=D.useCallback(e=>{var t;return(null==(t=null==e?void 0:e.playerdetails)?void 0:t.length)?u.jsx("div",{className:"player-list-table",children:u.jsxs(b,{value:e.playerdetails,removableSort:!0,sortMode:"multiple",scrollable:!0,emptyMessage:s.noPlayersAvailable,children:[u.jsx(y,{field:"name",header:s.nickname,sortable:!0}),u.jsx(y,{field:"score",header:s.score,sortable:!0}),u.jsx(y,{body:a,header:s.duration})]})}):null},[a,s]),o=D.useCallback((e,t,a)=>u.jsxs("div",{className:"server-info-card",children:[u.jsxs("span",{children:[s.name,": ",null==e?void 0:e.name]}),u.jsxs("span",{children:["IP: ",t,u.jsx(v,{label:"ðŸ“„",className:"large-emoji-button app-focus-ring",style:{scale:"0.8",verticalAlign:"unset"},onClick:()=>{navigator.clipboard.writeText(t),l.SUCCESS(h.COPY_SUCCESS)},children:u.jsx("span",{className:"large-copy-emoji",children:"ðŸ“„"})})]}),u.jsxs("span",{children:[s.players,": ",null==e?void 0:e.players,"/",null==e?void 0:e.maxplayers," (",null==e?void 0:e.bots," ",1===(null==e?void 0:e.bots)?s.bot:s.bots,")"]}),u.jsxs("span",{children:[s.status,": ","1"===(null==e?void 0:e.status)?s.online:s.offline]}),u.jsxs("span",{children:[s.map,": ",null==e?void 0:e.map]}),u.jsx("span",{children:u.jsx(v,{label:s.joinGame,className:"app-focus-ring",onClick:()=>{window.location.href=a}})}),n(e)&&u.jsx("span",{children:n(e)})]}),[n,s]);return u.jsxs("div",{className:"section future-rot server-info-section",children:[o(e,f.IP,f.STEAM_CONNECT_URL),u.jsxs("div",{className:"server-info-card",children:[u.jsxs("span",{children:[s.name,": ",g.FALLBACK_NAME]}),u.jsxs("span",{children:["IP: ",g.IP,u.jsx(v,{label:"ðŸ“„",className:"large-emoji-button app-focus-ring",style:{scale:"0.8",verticalAlign:"unset"},onClick:()=>{navigator.clipboard.writeText(g.IP),l.SUCCESS(h.COPY_SUCCESS)},children:u.jsx("span",{className:"large-copy-emoji",children:"ðŸ“„"})})]}),u.jsx("span",{children:u.jsx(v,{label:s.joinGame,className:"app-focus-ring",onClick:()=>{window.location.href=g.STEAM_CONNECT_URL}})})]}),u.jsxs("span",{className:"centered-text",children:[s.customMapsText,u.jsx("a",{style:{display:"inline-block",marginLeft:"10px",textDecoration:"none",color:"white",WebkitTextStroke:" 3px red"},href:"https://steamcommunity.com/sharedfiles/filedetails/?id=2542824628",children:s.here})]})]})}),P={useCommandsLoadingService:()=>{U()},getCommands:()=>fetch(`${m.COMMANDS}/getCommands`,{method:"get"}).then(e=>{if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return e.json()}).then(e=>{r.dispatch(C.setCommands(e))}).catch(e=>{l.ERROR(`Error while fetching commands: ${e.message}`)}),addNewCommand:e=>fetch(`${m.COMMANDS}/addCommand`,{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify({command:e.command,description:e.description})}).then(e=>{if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return e.json()}).then(e=>(P.getCommands(),e)).catch(e=>{throw l.ERROR(`Error while adding new command: ${e.message}`),e}),deleteCommand:e=>fetch(`${m.COMMANDS}/deleteCommand`,{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:e.id})}).then(e=>{if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return e.json()}).then(e=>(P.getCommands(),e.message)).catch(e=>{throw l.ERROR(`Error while deleting command: ${e.message}`),e}),updateCommand:e=>fetch(`${m.COMMANDS}/updateCommand`,{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:e.id,command:e.command,description:e.description})}).then(e=>{if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return e.json()}).then(e=>(P.getCommands(),e.message)).catch(e=>{throw l.ERROR(`Error while updating command: ${e.message}`),e})},U=()=>{D.useEffect(()=>{P.getCommands()},[])};function V(e){const s=x();return u.jsxs(u.Fragment,{children:[u.jsx("h5",{children:s.command}),u.jsx(S,{className:"app-focus-ring",value:e.command,onChange:s=>e.setCommand(s.target.value)}),u.jsx("h5",{children:s.description}),u.jsx(S,{className:"app-focus-ring",value:e.commandDescription,onChange:s=>e.setCommandDescription(s.target.value)})]})}function L(e){const s=x(),t=j();return u.jsx(E,{visible:e.isDialogVisible,header:s.editCommand,modal:!0,className:"p-fluid app-dialog",footer:u.jsxs(u.Fragment,{children:[u.jsx(v,{label:`âŒ ${t.cancel}`,className:"p-button-text app-focus-ring",onClick:()=>{e.commandEditingIdRef.current=-1,e.setDialogVisibility(!1)}}),u.jsx(v,{label:`âœ… ${t.update}`,className:"p-button-text app-focus-ring",onClick:()=>{const s={command:e.command,description:e.commandDescription,id:e.commandEditingIdRef.current};P.updateCommand(s).then(()=>{l.SUCCESS(t.update),e.setDialogVisibility(!1),e.commandEditingIdRef.current=-1}).catch(e=>{l.ERROR(`${t.error}: ${e.message}`)})}})]}),onHide:()=>{e.setDialogVisibility(!1)},children:u.jsx(V,{command:e.command,commandDescription:e.commandDescription,setCommand:e.setCommand,setCommandDescription:e.setCommandDescription})})}function F(e){const s=x(),t=j(),a=u.jsxs(u.Fragment,{children:[u.jsx(v,{label:`âŒ ${t.cancel}`,className:"p-button-text app-focus-ring",onClick:()=>e.setDialogVisibility(!1)}),u.jsx(v,{label:`âœ… ${t.save}`,className:"p-button-text app-focus-ring",onClick:()=>{const t={command:e.command,description:e.commandDescription};P.addNewCommand(t).then(()=>{l.SUCCESS(s.successfullyAdded),e.setDialogVisibility(!1),e.setCommandDescription("")}).catch(e=>{l.ERROR(`${s.couldntAdd}: ${e.message}`)})}})]});return u.jsx(E,{visible:e.isDialogVisible,header:s.addNewCommand,modal:!0,className:"p-fluid app-dialog",footer:a,onHide:()=>e.setDialogVisibility(!1),children:u.jsx(V,{setCommandDescription:e.setCommandDescription,commandDescription:e.commandDescription,setCommand:e.setCommand,command:e.command})})}function H(){const e=R(e=>e.userDataReducer.isAdmin),s=R(e=>e.commandsReducer.commands),t=x(),[a,n]=D.useState(""),o=D.useRef(-1),[r,i]=D.useState(""),[c,m]=D.useState(!1),[d,p]=D.useState(!1);P.useCommandsLoadingService();return u.jsxs("div",{className:"section commands-section app-surface",children:[u.jsx(F,{setCommandDescription:n,commandDescription:a,setCommand:i,command:r,isDialogVisible:c,setDialogVisibility:m}),u.jsx(L,{setCommandDescription:n,commandDescription:a,setCommand:i,command:r,commandEditingIdRef:o,isDialogVisible:d,setDialogVisibility:p}),e&&u.jsx(N,{className:"mb-4 commands-toolbar app-toolbar",start:u.jsx(u.Fragment,{children:e&&u.jsx(v,{label:`âž• ${t.newCommand}`,className:"mr-2 app-focus-ring","data-toggle":"tooltip",title:t.addNewCommandTooltip,onClick:()=>m(!0)})})}),u.jsxs(b,{value:s,responsiveLayout:"scroll",className:"commands-table app-data-table",emptyMessage:t.noCommandsAvailable,children:[u.jsx(y,{field:"command",header:t.command}),u.jsx(y,{field:"description",header:t.description}),e&&u.jsx(y,{header:t.actions,body:e=>u.jsxs(u.Fragment,{children:[u.jsx(v,{"data-toggle":"tooltip",title:t.editCommandTooltip,label:"âœï¸",className:"p-button-rounded mr-2 command-action-button app-focus-ring",onClick:()=>{o.current=e.id,p(!0),i(e.command),n(e.description)}}),u.jsx(v,{"data-toggle":"tooltip",title:t.deleteCommandTooltip,label:"ðŸ—‘ï¸",className:"p-button-rounded p-button-danger command-action-button app-focus-ring",onClick:()=>{P.deleteCommand(e).then(e=>{l.SUCCESS(`${e}`),m(!1),n("")}).catch(e=>{l.ERROR(`${t.couldntDelete}: ${e}`)})}})]})})]})]})}function K(){return u.jsx(w,{imageUrl:T.BACKGROUND_1,children:u.jsxs("div",{className:"home-page",children:[u.jsx(_,{}),u.jsx(H,{})]})})}export{K as default};
